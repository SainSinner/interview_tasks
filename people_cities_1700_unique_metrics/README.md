## **Задание 1:  Разработать структуру хранения данных и функции, предоставляющие определенную выборку из этих данных.**

Структуры данных:
Используя БД PostgreSQL, необходимо продумать и реализовать архитектуру хранения данных под следующую задачу:

Каждый час, поступает информация о людях, живущих в 5 крупных городах*, и 1700 различных уникально названных метрик по каждому человеку. Предусмотреть возможность расширения количества метрик  до 2700 шт.. Все метрики представляют собой числа.  Для хранения каждой метрики необходимо использовать отдельную колонку. Общее количество граждан данных городов - 5 миллионов. Они распределены не равномерно: 4млн.; 500 тыс.; 300 тыс.; 150 тыс.; 50 тыс..(можно сгенерировать в пропорции 45 людей в одном городе и т.д.) Идентификаторами гражданина является фамилия и имя**. В разных городах могут встречаться полные тёски, в одном городе нет полных тёсок. 

*Имена городов взять как имена любых реально существующих городов.

**Имена и фамилия можно сгенерировать случайным набором символов.

***Для проверки корректности функций с опцией агрегирования должны соблюдаться следующие правила: 

* В данных должны быть минимум несколько часов за одни сутки.
* В данных должны быть минимум несколько суток за одну неделю.
* В данных должны быть несколько недель.
* В данных должны быть несколько месяцев. 


## **Функции: Необходимо реализовать несколько максимально быстрых функций возвращающих курсоры на данные. Функции должны быть написаны с учетом возможного расширения количества метрик в заложенной архитектуре.**

* Функция поиска гражданина по фамилии или по фамилии и имени.
Возвращает курсор на город, фамилию, имя человека, а так же указывает две даты: время самой ранней информации о гражданине и время самой последней информации о нём.

* Функция, предоставляющая исходные данные по конкретному гражданину.
Возвращает курсор на запрашиваемые метрики*  по конкретному гражданину за весь период времени или за указанный промежуток времени. Опционально может передаваться параметр агрегирования на большие периоды(DY – день, WK- неделя, MO - месяц). В этом случае необходимо представить суммарное значение каждой метрики или формулы** из метрик.
*передаются как имена колонок с соответствующим названием с разделителем запятая.

* Функция, предоставляющая суммарные данные по городам.
Возвращает курсор на запрашиваемые метрики* в разрезе городов за весь период времени или за указанный промежуток времени. Опционально может передаваться параметр агрегирования на большие периоды(DY – день, WK- неделя, MO - месяц). В этом случае необходимо представить суммарное значение каждой метрики или формулы** из метрик.
*передаются как имена колонок с соответствующим названием с разделителем запятая.

**Результатом задания должно стать описание архитектуры таблиц с DDL SQL архитектуры. Файл(ы) с кодом функций. И демонстрационные выборки в виде скриншотов с разнообразными, в том числе опциональными, входными параметрами вызова функций.**

## Общее описание схемы данных и её назначение.

Основным объектом является customer (покупатель) вокруг него строится схема customer.
Необходимо хранить метрики по персонам и предоставлять аналитику по метрикам в различных разрезах, разрезах персон, городов с возможностью фильтрации и агрегации временных периодов.

## Подробное описание каждой таблицы (поля, индексы, ключи).

### Таблица: customer
* Назначение: Хранение информации о клиентах.
* Структура:

| Поле | Тип данных | Описание |
|-------------|-------------|-------------|
|customer_id|integer|Уникальный идентификатор клиента.|
|name|text|Имя клиента.|
|email|text|Электронная почта клиента.|
|created_at|timestamp|Дата и время создания записи.|
* Инедксы: customer_pkey (Primary Key): customer_id

### Таблица: city
* Назначение: Справочник городов.
* Структура:

| Поле | Тип данных | Описание |
|-------------|-------------|-------------|
| city_id | integer | Уникальный идентификатор города. |
| name | text | Название города. |
* Инедксы: customer_pkey (Primary Key): city_id

### Таблица: metric
* Назначение: Справочник метрик.
* Структура:

| Поле | Тип данных | Описание |
|-------------|-------------|-------------|
| metric_id | integer | Уникальный идентификатор метрики. |
| name | text | Название столбца метрики. |
| explain | text | Объяснение/назначение метрики. |
| data_type | text | Тип данных метрики. |
| table_name | text | Название таблицы, в которой хранится метрика. |
* Инедксы: customer_pkey (Primary Key): cmetric_id

Ниже описание таблицы метрики, оно универсально для любого порядкового номера таблицы 1 или 2, такой подход выбран потому что нельзя создать таблицу в PosgreSQL у которой было бы больше 1600 столбцов.
### Таблица: customer_metric_default_(порядковый номер таблицы)
* Назначение: Таблица мтерик (порядковый номер таблицы).
* Структура:

| Поле | Тип данных | Описание |
|-------------|-------------|-------------|
| customer_id | integer | Уникальный идентификатор клиента. |
| metric_timestamp | TIMESTAMP | Момент времени, к которому относятся метрики. |
| metric_* | numeric | Значение метрики (может быть несколько столбцов: metric_1, metric_2 и т.д.). |

* Индексы:
* * customer_metric_idx_customer_id_metric_timestamp_(порядковый номер таблицы) on (customer_id, metric_timestamp)
* * customer_metric_idx__timestamp_day_(порядковый номер таблицы) on (date_trunc('day'::text, metric_timestamp))
* * customer_metric_idx__timestamp_ week_(порядковый номер таблицы) on (date_trunc(' week'::text, metric_timestamp))
* Партиционирование:
* * Таблица партиционирована по месяцам на основе поля metric_timestamp (создано партиционирование на 4 года вперед, по правильному нужно создавать партиционирование через триггер).

## Общий вид схемы customer
![main_view_customer.png](PNG%2Fmain_view_customer.png)

### Весь SQL код представлен в 
[Весь SQL код.](https://github.com/SainSinner/interview_tasks/tree/main/people_cities_1700_unique_metrics/people_cities_1700_unique_metrics_solvation.sql)

### DDL описан в регионе «-- region DDL создания схемы customer с заполнением ее данными»

### Функции описаны в регионе «-- region Функции и их проверка»

## Демонстрационные выборки в виде скриншотов с разнообразными, в том числе опциональными, входными параметрами вызова функций

#### Функция поиска человека по фамилии и имени

![fn_people_lastName_firstName.png](PNG%2Ffn_people_lastName_firstName.png)

#### Функция поиска человека по фамилии

![fn_people_lastName.png](PNG%2Ffn_people_lastName.png)
 
#### Функция, предоставляющая исходные данные по конкретному гражданину. За весь период времени

![fn_citizen_data_history.png](PNG%2Ffn_citizen_data_history.png)
 
#### Функция, предоставляющая исходные данные по конкретному гражданину. За весь указанный промежуток времени

![fn_citizen_data_history_filter.png](PNG%2Ffn_citizen_data_history_filter.png)

#### Функция, предоставляющая исходные данные по конкретному гражданину. За весь указанный промежуток времени c агрегацией по месяцам.

![fn_citizen_data_history_filter_agg_month.png](PNG%2Ffn_citizen_data_history_filter_agg_month.png)
 
#### Функция, предоставляющая исходные данные по конкретному гражданину. За весь указанный промежуток времени c агрегацией по дням.

![fn_citizen_data_history_filter_agg_day.png](PNG%2Ffn_citizen_data_history_filter_agg_day.png)

#### Функция, предоставляющая исходные данные по конкретному гражданину. За весь указанный промежуток времени c агрегацией по дням и ограничением времени с одной стороны временного  отрезка.

![fn_citizen_data_history_filter_agg_day_limit.png](PNG%2Ffn_citizen_data_history_filter_agg_day_limit.png)

#### Функция, предоставляющая суммарные данные по городам.
Здесь добавил возможность суммировать метрики за весь период по городам, флаг ALL для этого нужно использовать
#### Функция, предоставляющая суммарные данные по городам. В разрезе городов за весь период времени

![fn_summary_data_city.png](PNG%2Ffn_summary_data_city.png)

#### Функция, предоставляющая суммарные данные по городам. В разрезе городов за указанный промежуток времени

![fn_summary_data_city_time_limit.png](PNG%2Ffn_summary_data_city_time_limit.png)

#### Функция, предоставляющая суммарные данные по городам. В разрезе городов с агрегацией по месяцам
Представлена только Москва потому, что сгенерил только 1 млн записей с метриками, если больше, то появятся и другие города.

![fn_summary_data_city_agg_month.png](PNG%2Ffn_summary_data_city_agg_month.png)

#### Функция, предоставляющая суммарные данные по городам. В разрезе городов суммирует показатели за промежуток заданный на входе
Представлена только Москва потому, что сгенерил только 1 млн записей с метриками, если больше, то появятся и другие города.
Здесь добавил возможность суммировать метрики за весь период по городам, флаг ALL для этого нужно использовать

![fn_summary_data_city_last.png](PNG%2Ffn_summary_data_city_last.png)